<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Walkthrough</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css" rel="stylesheet">
    <link href="https://cdn.rebilly.com/framepay/v1/rebilly.css" rel="stylesheet">
    <script src="https://cdn.rebilly.com/framepay/v1/rebilly.js"></script>
    <style>
        .divider {
            height: 1px;
            margin: 1em 0;
        }
    </style>
</head>
<body>
<section>
    <div class="container">
        <section id="setup">
            <label class="label">Sandbox Publishable API Key</label>
            <div class="field is-grouped">
                <p class="control is-expanded">
                    <input class="input" id="pub-key" placeholder="pk_sandbox_123456789" type="text">
                </p>
                <p class="control">
                    <a class="button is-info" id="continue">
                        Continue
                    </a>
                </p>
            </div>
            <p class="help">Enter your sandbox mode publishable API key and press <strong>Enter</strong> or click
                <strong>Continue</strong></p>
        </section>
        <div class="divider"></div>
        <section id="form">
            <h4 class="title is-4">Customer Information</h4>
            <section id="errors" style="display: none">
                <article class="message is-danger">
                    <div class="message-body">
                        <div class="content">
                            Please review these errors:
                            <ul id="error-list"></ul>
                        </div>
                    </div>
                </article>
                <div class="divider"></div>
            </section>
            <div class="field">
                <label class="label">First Name</label>
                <div class="control">
                    <input autocomplete="given-name" class="input" disabled id="first-name" placeholder="John"
                           type="text">
                </div>
            </div>
            <div class="field">
                <label class="label">Last Name</label>
                <div class="control">
                    <input autocomplete="family-name" class="input" disabled id="last-name" placeholder="Doe"
                           type="text">
                </div>
            </div>
            <div class="field">
                <label class="label">Payment Card</label>
                <div id="mounting-point">
                    <div class="control">
                        <input class="input" disabled type="text">
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="field is-grouped">
                <div class="control">
                    <button class="button is-link" disabled id="submit">Submit</button>
                </div>
                <div class="control">
                    <button class="button is-text" disabled id="reset">Reset</button>
                </div>
            </div>
            <section id="result" style="display: none">
                <div class="divider"></div>
                <article class="message is-info">
                    <div class="message-body">
                        <p>A payment token with <strong id="token">ID 12312312312</strong> was successfully created.
                            Check the <a href="https://app-sandbox.rebilly.com/api-logs" target="_blank">sandbox API
                                logs in Rebilly</a> to see the request.</p>
                        <p>Click on <strong>Reset</strong> to start again or submit the form to update the payment token
                            ID.</p>
                    </div>
                </article>
            </section>
        </section>
    </div>
</section>
<script>
    (function () {
        var fields = {
            continue: document.getElementById('continue'),
            form: document.getElementById('form'),
            mountingPoint: document.getElementById('mounting-point'),
            pubKey: document.getElementById('pub-key'),
            reset: document.getElementById('reset'),
            submit: document.getElementById('submit'),
            firstName: document.getElementById('first-name'),
            lastName: document.getElementById('last-name'),
            errors: document.getElementById('errors'),
            errorList: document.getElementById('error-list'),
            result: document.getElementById('result'),
            token: document.getElementById('token'),
        };

        var errors = [];

        var enableForm = function enableForm() {
            ['submit', 'reset', 'firstName', 'lastName'].forEach(function (name) {
                fields[name].removeAttribute('disabled');
            });
            ['continue', 'pubKey'].forEach(function (name) {
                fields[name].setAttribute('disabled', 'disabled');
            });
            // clear dummy field from form before mounting
            fields.mountingPoint.innerHTML = null;
            var card = Rebilly.card.mount(fields.mountingPoint, 'card');
        };

        var setPubKey = function setPubKey() {
            if (fields.continue.hasAttribute('disabled')) {
                return;
            }
            var key = fields.pubKey.value.trim();
            if (key !== '') {
                showValidationErrors([]);
                try {
                    Rebilly.initialize({
                        publishableKey: key,
                    });
                    enableForm();
                } catch (error) {
                    if (error.message === 'bad-publishable-key') {
                        showValidationErrors(['The provided publishable API key is invalid']);
                    } else {
                        console.error(error);
                    }
                }
            } else {
                showValidationErrors(['Please provide a sandbox publishable API key']);
            }
        };

        var setPubKeyOnEnter = function setPubKeyOnEnter(evt) {
            if (evt.key === 'Enter') {
                setPubKey(evt);
            }
        };

        var toggleErrorVisibility = function toggleErrorVisibility(target) {
            var state = target === undefined ? true : target;
            fields.errors.style.display = state ? 'block' : 'none';
        };

        var showValidationErrors = function showValidationErrors(errors) {
            if (!errors.length) {
                toggleErrorVisibility(false);
                return;
            }
            toggleErrorVisibility(true);
            fields.errorList.innerHTML = null;
            errors.forEach(function (line) {
                var item = document.createElement('li');
                item.appendChild(document.createTextNode(line));
                fields.errorList.appendChild(item);
            });
        };

        var setToken = function setToken(token) {
            if (token === null) {
                fields.result.style.display = 'none';
                return;
            }
            fields.result.style.display = 'block';
            fields.token.innerHTML = 'ID ' + token;
        };

        var createToken = function createToken() {
            // reset errors
            errors = [];
            // we are not using a <form> so we will
            // compute the extra data manually
            var extraData = {
                billingAddress: {
                    firstName: fields.firstName.value.trim(),
                    lastName: fields.lastName.value.trim(),
                },
            };
            showValidationErrors(errors);
            setToken(null);
            fields.submit.setAttribute('disabled', 'disabled');
            Rebilly.createToken(fields.form, extraData)
                .then(function (token) {
                    // we have a token field in the form
                    // thus we can submit directly
                    setToken(token.id);
                    fields.submit.removeAttribute('disabled');
                })
                .catch(function (error) {
                    fields.submit.removeAttribute('disabled');
                    // see error.code and error.message
                    if (error.message) {
                        errors.push(error.message);
                    } else if (error.errors) {
                        error.errors.forEach(function (line) {
                            errors.push(line.message);
                        });
                    } else if (error.status) {
                        if (error.status === 401) {
                            alert('The provided API key was not found. Please update it and try again.');
                            window.location.reload();
                        }
                    }
                    showValidationErrors(errors);
                });
        };

        fields.pubKey.addEventListener('keypress', setPubKeyOnEnter);
        fields.continue.addEventListener('click', setPubKey);
        fields.submit.addEventListener('click', createToken);
        fields.reset.addEventListener('click', function () {
            window.location.reload();
        });
    })();
</script>
</body>
</html>
